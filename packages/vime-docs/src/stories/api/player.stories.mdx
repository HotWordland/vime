import { Meta } from '@storybook/addon-docs/blocks';
import LinkTo from '@storybook/addon-links/react';

<Meta title="API/Player" />

# Player `interface`

⚠️ **Important**

Svelte batches tasks to be performed asynchronously. Rendering component instances, modifying the DOM or
updating computed properties will not happen synchronously. Svelte automatically schedules these tasks to 
be performed in the next update cycle. If you do perform a change that causes any of the prior mentioned events, then 
you'll need to wait for pending state changes to be flushed. You can use `player.tick()` to do exactly that.

```js
player.tick().then(() => { console.log('changes applied.'); });
```

## Store

**Stores are plain JS objects and can be used anywhere, not just inside a Svelte component/application.**

All props below are powered behind the scenes by a [Svelte store](https://svelte.dev/docs#svelte_store).
It basically enables reactive values via the [Publish-subscribe pattern](https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern).
Here's a [simple demonstration](https://svelte.dev/repl/491fe50dea394e0b9a872af9f79b2416?version=3.20.1) to see how they
work. You can also checkout the [Svelte tutorial on stores](https://svelte.dev/tutorial/writable-stores).

Simply put, they are plain JS objects that contain a `subscribe` function and an optional `set` function.
You can subscribe to receive updates of some value as it changes over time. The `subscribe` function
returns an `unsubscribe` function that you can call to stop listening.

📝 When you are getting a prop `player.someProp` we are simply calling `get(propStore)`, and when setting
a prop `player.someProp = 1` we are calling `propStore.set(newValue)` if the value has changed.

### Usage

```js
// All props below are available here.
const { paused } = player.getStore();

const unsubscribe = paused.subscribe(isPaused => {
  console.log('paused state changed to:', isPaused);
});

// ...

unsubscribe();
```

## Props

### `src: any`

**Default:** `null`

The `src` of the current media, see <LinkTo kind="guides-setting-src--page">Guides/Setting Src</LinkTo>
for how to set this prop.

### `canSetPoster: boolean` `(readonly)`

**Default:** `false`

Whether the current provider supports setting a custom poster.

### `poster: string|null`

**Default:** `null`

A custom poster to load if a provider supports it. You can check [`canSetPoster`](#cansetposter-boolean-readonly) 
before you try setting this property.

### `provider: component|null` `(readonly)`

**Default:** `null`

The current active provider instance.

### `origin: string|null` `(readonly)`

**Default:** `16:9`

Where the `src` request had originated from without any path information.

### `title: string|null` `(readonly)`

**Default:** `null`

The title of the current media.

### `currentSrc: any` `(readonly)`

**Default:** `null`

The src that is currently loaded. This is useful when using Html5 video qualities and for future playlist support.

### `playbackReady: boolean` `(readonly)`

**Default:** `false`

Whether the current media is ready for playback.

### `rebuilding: boolean` `(readonly)`

**Default:** `false`

If the provider is currently rebuilding itself. This happens if we are forced to send a new parameter
to the embed. For example, there is no API for enabling/disabling YouTube controls, so we change it
via the controls parameter.

### `canInteract: boolean` `(readonly)`

**Default:** `false`

Whether you can interact with the player. If `true` then the player is ready for playback and it's not currently rebuilding.

### `useNativeView: boolean` `(readonly)`

**Default:** `true`

Whether the provider should display any elements outside of the controls, such as titles, logos
etc. Not all providers support this.

### `useNativeControls: boolean` `(readonly)`

**Default:** `true`

Whether to show/hide native controls.

### `useNativeCaptions: boolean` `(readonly)`

**Default:** `true`

Whether to enable/disable native captions. If `false` then the provider is given an empty set of `tracks`.

### `nativePoster: string|null` `(readonly)`

**Default:** `null`

The absolute URL of the native poster for the current src. For example, the thumbnail for a YouTube video.

### `mediaType: MediaType` `(readonly)`

**Default:** `0`

The type of the media, see <LinkTo kind="api-mediatype--page">API/MediaType</LinkTo>.

### `isAudio: boolean` `(readonly)`

**Default:** `false`

Whether the current media is of type audio.

### `isVideo: boolean` `(readonly)`

**Default:** `false`

Whether the current media is of type video.

### `isLive: boolean` `(readonly)`

**Default:** `false`

Whether the current media is a live stream.

### `paused: boolean`

**Default:** `true`

Whether the player is paused or not.

### `currentTime: double`

**Default:** `0`

The current playback time in seconds, setting this will seek the media to the new time.

### `buffered: double` `(readonly)`

**Default:** `0`

The length of the media that the browser has loaded in seconds.

### `duration: double` `(readonly)`

**Default:** `0`

The total playback length of the media in seconds.

### `muted: boolean`

**Default:** `false`

Whether the audio is muted or not.

### `volume: int`

**Default:** `30`

An integer `(0 - 100)` that determines the current volume level of the audio. If `0`, the audio is muted.
This cannot be set on mobile as it is controlled by system controls.

### `playing: boolean` `(readonly)`

**Default:** `false`

Whether the current media is playing or not.

### `buffering: boolean` `(readonly)`

**Default:** `false`

Whether the current media is buffering (temporarily paused loading), or not.

### `playbackStarted: boolean` `(readonly)`

**Default:** `false`

Whether playback has started or not.

### `playbackEnded: boolean` `(readonly)`

**Default:** `false`

Whether playback has ended or not.

### `seeking: boolean` `(readonly)`

**Default:** `false`

Whether the player is seeking to a new time or not.

### `isPlayerActive: boolean` `(readonly)`

**Default:** `false`

Whether this is the currently active player or not. The player is active if it is the last player
to have been interacted with programtically or by the user.

### `isControlsEnabled: boolean`

**Default:** `true`

Whether to show or hide controls.

### `isControlsActive: boolean` `(readonly)`

**Default:** `true`

Whether the the controls are currently visible or not. 

### `state: PlayerState` `(readonly)`

**Default:** `1`

The current state of the player, see <LinkTo kind="api-playerstate--page">API/PlayerState</LinkTo>.

### `canSetPlaybackRate: boolean` `(readonly)`

**Default:** `false`

Whether the current provider supports setting the playback rate.

### `playbackRates: double[]` `(readonly)`

**Default:** `[1]`

The list of available playback rates.

### `playbackRate: double`

**Default:** `1`

The current playback rate of the media. You can check [`canSetPlaybackRate`](#cansetplaybackrate-boolean-readonly) 
before you try setting this property.

### `canSetVideoQuality: boolean` `(readonly)`

**Default:** `false`

Whether the current provider supports setting the video quality.

### `videoQualities: double[]` `(readonly)`

**Default:** `[]`

The list of available video qualities.

### `videoQuality: VideoQuality`

**Default:** `0`

The current video quality of the media, see <LinkTo kind="api-videoquality--page">API/VideoQuality</LinkTo>.
You can check [`canSetVideoQuality`](#cansetvideoquality-boolean-readonly) before you try setting this property.

### `isVideoView: boolean` `(readonly)`

**Default:** `false`

If the player is displayed as a video. It is `true` if there is a video loaded or if a poster is set.

### `isVideoReady: boolean` `(readonly)`

**Default:** `false`

If `isVideoView` is `true` and the player is ready for playback.

### `progress: object` `(readonly)`

The progress of the current playback and the amount buffered.

```js
// Example to demonstrate the shape of the object.
const progress = {
  played: {
    seconds: 30,
    percent: 25,
  },
  buffered: {
    seconds: 45,
    percent: 37.5,
  }
};
```

### `canSetTracks: boolean` `(readonly)`

**Default:** `false`

Whether the current provider supports setting tracks/captions.

### `tracks: object[]`

**Default:** `[]`

A list of tracks to be loaded. Each track is represented as a `object` that contains any valid 
[TextTrackElement](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/track) property.

### `canSetTrack: boolean` `(readonly)`

**Default:** `false`

Whether the current provider supports changing the text track.

### `currentTrackIndex: int`

**Default:** `-1`

The index of the currently active track. If it is `-1`, then no track is active.

### `currentTrack: null|object` `(readonly)`

**Default:** `null`

The currently active track.

### `isCaptionsActive: boolean` `(readonly)`

**Default:** `false`

If captions are currently visible or not. This is `false` if `currentTrackIndex` is `-1`.

### `canSetPiP: boolean` `(readonly)`

**Default:** `false`

Whether the current provider supports picture-in-picture (PiP). If this is `true`, it does not mean that 
any PiP request is guaranteed to be successful. It only means that the request can be made.

### `isPiPActive: boolean` `(readonly)`

**Default:** `false`

Whether the player is in picture-in-picture mode or not.

### `canSetFullscreen: boolean` `(readonly)`

**Default:** `false`

Whether fullscreen is supported via the native [Fullscreen API](https://developer.mozilla.org/en-US/docs/Web/API/Fullscreen_API)
or the current provider. If this is `true`, it does not mean that any fullscreen request is guaranteed to be 
successful. It only means that the request can be made.

### `isFullscreenActive: boolean` `(readonly)`

**Default:** `false`

Whether the player is in fullscreen mode or not.

### `autopause: boolean`

**Default:** `true`

Whether to pause this player when another player becomes active.

### `aspectRatio: string|null`

**Default:** `16:9`

The aspect ratio of the player expressed as `width:height`.

### `playsinline: boolean`

**Default:** `true`

When the player begins playback on mobile, whether it should play inline or go fullscreen. If 
`autoplay` is true then this will be forced to be `true`.

### `canAutoplay: boolean` `(readonly)`

**Default:** `false`

Whether we can automatically initiate playback. This assumes `playsinline` is true.

### `canMutedAutoplay: boolean` `(readonly)`

**Default:** `false`

Whether we can automatically initiate playback if the volume is muted. This assumes `playsinline` is true.

### `autoplay: boolean`

**Default:** `false`

Whether playback should begin as soon as it's ready. This will automatically fallback to `muting`
if `canAutoplay` returns `false`. In addition, the `playsinline` property will be forced to be `true`.

### `loop: boolean`

**Default:** `false`

Whether playback should start over from the beginning when it reaches the end.

## Methods

### `getStore(): object`

Returns an `object` where each `key` is a prop listed above, and the corresponding `value` is a 
[Svelte store](#store).

### `tick(): Promise<undefined>`

Returns a `Promise` that will resolve once all pending player state changes are flushed.

### `requestPiP(): Promise<string|undefined>`

Requests the player to enter picture-in-picture (PiP) mode. Returns a `Promise` that will resolve if the 
request is made, or reject with a reason for failure. A resolved `Promise` doesn't gurantee that it was successful.
To know when it is active or not, you can subscribe to [`isPiPActive`](#ispipactive-boolean-readonly).
You can also call [`canSetPiP`](#cansetpip-boolean-readonly) to see if the current provider supports it.

**Possible Rejection Reasons**

- The current provider does not support it.
- The request is made on an audio track.
- The player is not ready for playback.
- The user has not interacted with the page/player yet.

**Notes**

- At this time, captions are [not supported in PiP](https://bugs.chromium.org/p/chromium/issues/detail?id=854935).
- Only supported in Desktop Chrome 70+ and Desktop Safari 10+ at the moment.

**Listening to Changes**

```js
const { isPiPActive } = player.getStore();

const unsubscribe = isPiPActive.subscribe(isActive => {
  console.log('pip change:', isActive);
});

// ...

unsubscribe();
```

### `exitPiP(): Promise<string|undefined>`

Requests the player to exit picture-in-picture (PiP) mode. Returns a `Promise` that will resolve if the 
request is made, or reject with a reason for failure. See [`requestPiP()`](#requestpip-promisestringundefined)
for more information.

**Possible Rejection Reasons**

- Player is not in PiP mode.
- Player is out of view and has not mounted yet.

### `requestFullscreen(): Promise<string|undefined>`

Requests the player to enter fullscreen mode. Returns a `Promise` that will resolve if the 
request is made, or reject with a reason for failure. A resolved `Promise` doesn't gurantee that it was successful.
To know when it is active or not, you can subscribe to [`isFullscreenActive`](#isfullscreenactive-boolean-readonly).
You can also call [`canSetFullscreen`](#cansetfullscreen-boolean-readonly) to see if it is supported or not.

**Possible Rejection Reasons**

- The request is made on an audio track.
- The player is not ready for playback.
- The user has not interacted with the page yet.
- The [Fullscreen API](https://developer.mozilla.org/en-US/docs/Web/API/Fullscreen_API) is not available 
and the current provider does not support it.

**Notes**

- See [Fullscreen API support](https://caniuse.com/#feat=fullscreen).

**Listening to Changes**

```js
const { isFullscreenActive } = player.getStore();

const unsubscribe = isFullscreenActive.subscribe(isActive => {
  console.log('fullscreen change:', isActive);
});

// ...

unsubscribe();
```

### `exitFullscreen(): Promise<string|undefined>`

Requests the player to exit fullscreen mode. Returns a `Promise` that will resolve if the 
request is made, or reject with a reason for failure. See [`requestFullscreen()`](#requestfullscreen-promisestringundefined)
for more information.

**Possible Rejection Reasons**

- Player is not in fullscreen mode.
- Player is out of view and has not mounted yet.